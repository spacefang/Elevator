# 智能电梯运维平台 - 三级权限矩阵详细设计

## 核心设计原则

> **国/省重在"监管与统筹"，市级重在"执行与处置"**

```
权限设计金字塔：
                    ┌─────────────┐
                    │  总中心(国) │ ← 决策层：看全局、做决策、管供应链
                    │   监管督办   │
                    └──────┬──────┘
                           │
              ┌────────────┴────────────┐
              │       省中心(省)         │ ← 协调层：区域监管、资源调配
              │    统筹调度/监管分析     │
              └───────────┬─────────────┘
                          │
          ┌───────────────┴───────────────┐
          │         市中心(市)             │ ← 执行层：实时响应、现场处置
          │    一线操作/维修执行           │
          └───────────────────────────────┘
```

---

## 一、详细权限矩阵表

### 🔴 1. 运维概览 (可视化大屏)

| 维度 | 总数据中心 (北京) | 省运营中心 (湖北) | 市维保中心 (武汉) |
|------|------------------|------------------|------------------|
| **视角定位** | **上帝视角** | **区域视角** | **执行视角** |
| 地图展示 | 全国地图打点，32省市分布 | 省内13市州分布，故障热力图 | 市内13区分布，设备点位 |
| 核心指标 | 全国设备总数、总在线率、总故障率 | 省内在线率排名、故障率对比 | 市内实时在线数、故障数 |
| 趋势分析 | 年度/季度宏观趋势 | 月度/周度区域趋势 | 日/小时实时动态 |
| 告警展示 | 仅显示红色(重大)告警 | 显示橙色+红色告警 | 显示所有级别告警 |
| 工单概览 | 全国工单完成率统计 | 省内工单积压监控 | 市内待处理工单列表 |
| 刷新频率 | 5分钟/次 | 1分钟/次 | 实时推送 |
| **操作权限** | 查看、导出年报 | 查看、导出月报 | 查看、刷新 |

**数据范围SQL示例**:
```sql
-- 总中心查询
SELECT * FROM devices WHERE 1=1;

-- 省中心查询
SELECT * FROM devices WHERE province = '湖北';

-- 市中心查询
SELECT * FROM devices WHERE province = '湖北' AND city = '武汉';
```

---

### 🔴 2. 设备管理

| 功能项 | 总数据中心 | 省运营中心 | 市维保中心 |
|--------|-----------|-----------|-----------|
| **定位** | **资产建档** | **调拨/监管** | **实时监控** |
| 设备档案 | 全国设备生命周期查看 | 省内设备编辑、导入导出 | 市内设备详情查看 |
| 型号统计 | 按品牌/型号/年限分布 | 省内型号分布、故障率对比 | 无权限 |
| 状态监控 | 汇总统计 | 省内设备状态列表 | **单台实时状态**(楼层/速度/门) |
| 维保记录 | 全国维保次数统计 | 省内维保记录查看 | **维保记录新增/上传照片** |
| 设备调动 | 查看跨省调动记录 | **发起跨市调动申请** | 无权限 |
| 视频监控 | 无权限 | 省内关键设备视频查看 | **单台电梯视频实时查看** |
| 远程控制 | 无权限(仅紧急督办) | 无权限 | **远程开门/电梯锁定**(仅故障时) |
| **操作权限** | 查看、统计、导出 | 查看、编辑、调拨、审批 | 查看、监控、控制、记录 |

**权限点设计**:
```javascript
const permissions = {
  national: [
    'device:view:all',
    'device:statistics:all',
    'device:export:all'
  ],
  province: [
    'device:view:province',
    'device:edit:province',
    'device:transfer:province',
    'device:video:important'
  ],
  city: [
    'device:view:city',
    'device:monitor:realtime',
    'device:video:all',
    'device:control:emergency',
    'device:record:maintenance'
  ]
};
```

---

### 🔴 3. 告警中心 (新增模块)

| 告警级别 | 总数据中心 | 省运营中心 | 市维保中心 |
|---------|-----------|-----------|-----------|
| **红色(紧急)** | **重大事故督办** | **趋势监控** | **实时处置** |
| 困人告警 | ✅ 接收通知，督办处理 | ✅ 接收通知，监控时效 | ✅ 接收通知，**立即响应** |
| 极端故障 | ✅ 可查看全国 | ✅ 可查看省内 | ✅ 必须处理 |
| **橙色(重要)** | ❌ 不接收 | ✅ 接收通知，监控处理进度 | ✅ 接收通知，**转工单** |
| 门系统故障 | ❌ | ✅ 统计趋势 | ✅ 手动确认、派单 |
| **黄色(一般)** | ❌ 不接收 | ⚠️ 仅统计 | ✅ 接收，批量处理 |
| 轻微异常 | ❌ | ⚠️ | ✅ 定期巡检 |
| **操作** | 督办、查看进度 | 监控时效、统计分析 | **确认、转工单、处置、关闭** |

**告警分级规则**:
```json
{
  "red": {
    "name": "紧急",
    "conditions": ["困人", "冲顶", "坠梯", "火灾"],
    "response_time": "30分钟",
    "escalation": "未处理自动上报省中心"
  },
  "orange": {
    "name": "重要",
    "conditions": ["门故障", "制动器异常", "钢丝绳磨损"],
    "response_time": "2小时",
    "escalation": "4小时未处理上报"
  },
  "yellow": {
    "name": "一般",
    "conditions": ["温度偏高", "噪音异常", "振动超标"],
    "response_time": "4小时",
    "escalation": "8小时未处理提醒"
  }
}
```

**告警升级机制**:
```
市中心30分钟未响应 → 自动推送省中心
省中心1小时未介入 → 自动推送总中心
总中心可强制指派专家组
```

---

### 🔴 4. 维保派单

| 环节 | 总数据中心 | 省运营中心 | 市维保中心 |
|-----|-----------|-----------|-----------|
| **定位** | **绩效分析** | **调度监管** | **派单执行** |
| 工单创建 | ❌ 无权限 | ✅ **创建工单** | ✅ **紧急工单创建** |
| 工单分配 | ⚠️ 仅重大事故可指派 | ✅ **跨市调度、专家指派** | ✅ **市内技术员分配** |
| 工单接单 | ❌ | ❌ | ✅ **手机端接单、GPS打卡** |
| 工单执行 | ❌ | ❌ | ✅ **现场维修、拍照上传、配件登记** |
| 工单验收 | ❌ | ⚠️ 重大工单抽查验收 | ✅ **验收确认** |
| 工单统计 | ✅ 全国完成率、响应时间排名 | ✅ **省内积压监控、时效分析** | ✅ 市内工单列表 |
| 跨区协调 | ✅ 跨省技术支持 | ✅ **跨市专家调度** | ⚠️ 可申请外援 |
| **核心操作** | 查看、分析、督办 | **监控、调度、协调** | **接单、执行、上报** |

**工单流转流程**:
```
[告警触发] → [省中心审核] → [省中心创建工单]
                                    ↓
                        [自动/手动分配给市中心]
                                    ↓
                            [市中心技术员接单]
                                    ↓
                            [GPS打卡到达现场]
                                    ↓
                        [执行维修、拍照、登记配件]
                                    ↓
                            [提交完成、上传资料]
                                    ↓
                [市中心主管验收] → [工单关闭] → [数据归档]
```

**时效考核**:
```javascript
const sla = {
  urgent: {
    response: 30,  // 分钟
    arrive: 60,    // 分钟
    complete: 120  // 分钟
  },
  important: {
    response: 120,
    arrive: 240,
    complete: 480
  },
  normal: {
    response: 240,
    arrive: 480,
    complete: 1440
  }
};
```

---

### 🔴 5. 备品备件

| 层级 | 总数据中心 | 省运营中心 | 市维保中心 |
|-----|-----------|-----------|-----------|
| **定位** | **供应链管理** | **库存调配** | **出入库** |
| 库存查看 | 全国总库存、各省库存 | 省内各市库存分布 | 市仓库存明细 |
| 供应商 | ✅ **供应商管理、集采决策** | ⚠️ 查看供应商清单 | ❌ 无权限 |
| 采购管理 | ✅ **年度集采计划、框架协议** | ✅ **省内补货计划** | ⚠️ 紧急采购申请 |
| 库存调拨 | ✅ 跨省调拨审批 | ✅ **省内跨市调拨** | ⚠️ 可申请调拨 |
| 出库管理 | ⚠️ 查看出库统计 | ✅ 省内出库审批 | ✅ **工单关联出库、领料登记** |
| 入库管理 | ⚠️ 查看入库统计 | ✅ 省仓入库审核 | ✅ **市仓入库登记** |
| 库存预警 | 全国低库存预警 | **省内库存优化建议** | **易损件申请** |
| 盘点管理 | 年度盘点计划 | 季度盘点执行 | **月度盘点、差异上报** |
| **核心操作** | 供应链决策、集采 | **调拨、补货、优化** | **领料、登记、盘点** |

**三级库存架构**:
```
总仓(北京) - 战略储备
├── 钢丝绳: 5000根
├── 制动器: 3000个
├── 门机: 2000套
└── 控制柜: 1000台

省仓(湖北) - 区域调配
├── 钢丝绳: 500根
├── 制动器: 300个
├── 门机: 200套
└── 控制柜: 100台

市仓(武汉) - 快速响应
├── 钢丝绳: 50根 ⚠️ 低库存
├── 制动器: 30个
├── 门机: 20套
└── 控制柜: 10台
```

**调拨流程**:
```
市仓库存 < 最低阈值 → 自动生成申请 → 省中心审批
                                        ↓
                            [库存充足] → 同意调拨 → 物流配送
                                        ↓
                            [库存不足] → 向总仓申请 → 总中心审批
```

---

### 🔴 6. 数据分析

| 分析维度 | 总数据中心 | 省运营中心 | 市维保中心 |
|---------|-----------|-----------|-----------|
| **定位** | **决策支持** | **运营分析** | **设备诊断** |
| 品牌分析 | ✅ **品牌故障率排名、质量评估** | ⚠️ 省内品牌分布查看 | ❌ 无权限 |
| 区域分析 | ✅ **各省维保质量评估报告** | ✅ **省内各市对比分析** | ⚠️ 市内区域分析 |
| 故障分析 | ✅ 全国故障类型分布、趋势预测 | ✅ **故障高发时段/区域** | ✅ **单梯故障频次** |
| 维保分析 | ✅ 全国维保效率排名 | ✅ **省内维保质量评分** | ⚠️ 技术员绩效 |
| 能耗分析 | ✅ 全国能耗对比、节能潜力 | ✅ **省内高能耗站点Top10** | ✅ **单梯能耗趋势** |
| 健康度评分 | ✅ 全国设备健康度分布 | ✅ 省内风险设备清单 | ✅ **单梯健康度详情** |
| 预测模型 | ✅ **预测性维护模型训练** | ⚠️ 查看预测结果 | ⚠️ 接收预警 |
| 报表导出 | ✅ **年度/季度决策报告** | ✅ **月度运营报表** | ✅ 日常工作报表 |
| **核心能力** | 宏观决策、模型优化 | **区域优化、资源调配** | **设备诊断、预防维护** |

**报表类型**:
```
总中心报表：
├── 年度设备质量白皮书
├── 供应商评估报告
├── 维保效率全国排名
└── 碳排放趋势分析

省中心报表：
├── 月度运营简报
├── 故障高发区域分析
├── 维保质量评分表
└── 资源配置优化建议

市中心报表：
├── 日常工单统计表
├── 技术员绩效表
├── 配件消耗明细
└── 单梯健康度报告
```

---

### 🔴 7. 能耗概览

| 功能 | 总数据中心 | 省运营中心 | 市维保中心 |
|-----|-----------|-----------|-----------|
| **定位** | **碳排放统计** | **异常监控** | **电费核算** |
| 能耗总览 | ✅ **全国能耗总量、碳排趋势** | ✅ 省内能耗汇总 | ✅ 市内能耗统计 |
| 对比分析 | ✅ **各省能耗对比、排名** | ✅ **省内各市对比** | ⚠️ 市内区域对比 |
| 异常监控 | ⚠️ 仅看极端异常 | ✅ **高能耗站点Top10** | ✅ **单梯能耗曲线** |
| 节能模式 | ✅ 节能政策制定 | ✅ 节能方案推广 | ✅ **节能模式启用/查看效果** |
| 电费核算 | ✅ 全国电费总支出 | ✅ 省内电费分摊 | ✅ **单梯电费详单** |
| 碳排放 | ✅ **碳排放总量、碳中和计划** | ⚠️ 省内碳排放统计 | ❌ 无权限 |
| 峰谷电价 | ✅ 电价策略制定 | ✅ 峰谷时段优化 | ✅ **峰谷电价曲线查看** |
| **核心操作** | 战略规划、政策制定 | **异常监控、方案推广** | **日常核算、模式调整** |

**能耗数据粒度**:
```
总中心: 月度/年度汇总
省中心: 日/周/月对比
市中心: 小时级实时数据
```

---

## 二、权限控制技术方案

### 1. RBAC权限模型

```javascript
// 角色定义
const roles = {
  NATIONAL_ADMIN: {
    name: '总中心管理员',
    level: 1,
    scope: 'national',
    permissions: [
      'overview:view:national',
      'device:statistics:all',
      'alert:supervise:critical',
      'workorder:analyze:all',
      'inventory:supplier:manage',
      'analysis:report:strategic',
      'energy:carbon:statistics'
    ]
  },
  PROVINCE_ADMIN: {
    name: '省中心管理员',
    level: 2,
    scope: 'province',
    region: 'hubei',
    permissions: [
      'overview:view:province',
      'device:edit:province',
      'alert:monitor:trend',
      'workorder:dispatch:province',
      'inventory:transfer:province',
      'analysis:report:operational',
      'energy:monitor:abnormal'
    ]
  },
  CITY_OPERATOR: {
    name: '市中心操作员',
    level: 3,
    scope: 'city',
    region: 'hubei',
    city: 'wuhan',
    permissions: [
      'overview:view:city',
      'device:monitor:realtime',
      'alert:handle:all',
      'workorder:execute:city',
      'inventory:consume:city',
      'analysis:view:device',
      'energy:view:detail'
    ]
  }
};
```

### 2. 数据权限过滤

```java
// Spring Boot AOP权限拦截
@Aspect
public class DataScopeAspect {
    
    @Around("@annotation(dataScope)")
    public Object around(ProceedingJoinPoint point, DataScope dataScope) {
        User user = SecurityUtils.getCurrentUser();
        String sqlFilter = buildSqlFilter(user);
        
        // 动态添加WHERE条件
        return point.proceed();
    }
    
    private String buildSqlFilter(User user) {
        switch(user.getRole()) {
            case NATIONAL_ADMIN:
                return "1=1"; // 无限制
            case PROVINCE_ADMIN:
                return "province = '" + user.getRegion() + "'";
            case CITY_OPERATOR:
                return "province = '" + user.getRegion() + "' AND city = '" + user.getCity() + "'";
        }
    }
}
```

### 3. 前端权限控制

```vue
<!-- Vue 3 组件权限指令 -->
<template>
  <!-- 总中心才能看到的组件 -->
  <div v-permission="['national:admin']">
    <SupplierManagement />
  </div>
  
  <!-- 省中心和总中心都能看到 -->
  <div v-permission="['national:admin', 'province:admin']">
    <InventoryTransfer />
  </div>
  
  <!-- 所有角色都能看，但内容不同 -->
  <Dashboard :level="userLevel" />
</template>

<script setup>
import { usePermission } from '@/hooks/usePermission';

const { hasPermission, userLevel } = usePermission();
</script>
```

---

## 三、关键差异化设计

### 监控粒度差异

| 维度 | 总中心 | 省中心 | 市中心 |
|-----|--------|--------|--------|
| 时间粒度 | 年/季/月 | 月/周/日 | 日/时/分 |
| 空间粒度 | 省级汇总 | 市级分布 | 单台设备 |
| 数据深度 | 统计报表 | 趋势分析 | 实时监控 |
| 刷新频率 | 5-10分钟 | 1-5分钟 | 实时推送 |

### 操作权限差异

| 操作类型 | 总中心 | 省中心 | 市中心 |
|---------|--------|--------|--------|
| 查看 | 全量数据 | 区域数据 | 单点数据 |
| 编辑 | 配置/策略 | 区域信息 | 具体记录 |
| 审批 | 重大事项 | 区域事项 | 无权限 |
| 执行 | 督办 | 调度 | **一线操作** |

### 告警处理差异

```
红色告警(困人):
├── 总中心: 收到通知 → 督办 → 查看处理进度
├── 省中心: 收到通知 → 监控时效 → 必要时介入
└── 市中心: 立即响应 → 30分钟到场 → 解救并上报

橙色告警(门故障):
├── 总中心: 不接收
├── 省中心: 收到通知 → 监控处理 → 统计趋势
└── 市中心: 手动确认 → 创建工单 → 2小时内处理

黄色告警(温度异常):
├── 总中心: 不接收
├── 省中心: 仅统计
└── 市中心: 定期巡检 → 批量处理
```

---

## 四、实施建议

### 1. 数据库设计
```sql
-- 用户表增加数据范围
ALTER TABLE users ADD COLUMN data_scope VARCHAR(20);
ALTER TABLE users ADD COLUMN region VARCHAR(20);
ALTER TABLE users ADD COLUMN city VARCHAR(20);

-- 权限表
CREATE TABLE permissions (
  id INT PRIMARY KEY,
  code VARCHAR(100) UNIQUE,
  name VARCHAR(50),
  module VARCHAR(20),
  action VARCHAR(20),
  scope VARCHAR(20)
);

-- 角色权限关联表
CREATE TABLE role_permissions (
  role_id INT,
  permission_id INT,
  PRIMARY KEY (role_id, permission_id)
);
```

### 2. 接口设计
```
GET /api/v1/overview?scope=national|province|city
GET /api/v1/devices?region=hubei&city=wuhan
GET /api/v1/alerts?level=red,orange&scope=current_user
POST /api/v1/workorders (根据用户角色自动设置scope)
```

### 3. 前端路由
```javascript
const routes = [
  {
    path: '/overview',
    component: Overview,
    meta: { 
      roles: ['national', 'province', 'city'],
      dynamicContent: true  // 根据角色显示不同内容
    }
  },
  {
    path: '/supplier',
    component: SupplierManagement,
    meta: { roles: ['national'] }  // 仅总中心可访问
  },
  {
    path: '/realtime-monitor',
    component: RealtimeMonitor,
    meta: { roles: ['city'] }  // 仅市中心可访问
  }
];
```

---

## 五、典型场景演示

### 场景1: 困人告警处理流程

```
14:30 设备E1001困人告警触发
      ↓
14:30 [市中心] 收到红色告警推送
      ↓
14:31 [市中心] 技术员接单，GPS显示距离2.3km
      ↓
14:31 [省中心] 收到通知，开始监控处理时效
      ↓
14:32 [总中心] 收到督办通知(仅红色告警)
      ↓
14:45 [市中心] 技术员到达现场，开始救援
      ↓
14:48 [市中心] 救援成功，6人脱困
      ↓
14:50 [市中心] 上传现场照片，标记设备需维修
      ↓
14:51 [省中心] 创建维修工单，指派专业维修组
      ↓
15:00 [总中心] 确认事故处理完成，解除督办
```

### 场景2: 配件调拨流程

```
市仓钢丝绳库存: 12根 < 最低阈值(20根)
      ↓
[市中心] 生成补货申请
      ↓
[省中心] 查看省仓库存: 85根
      ↓
[省中心] 审批通过，调拨30根至武汉市仓
      ↓
[省中心] 生成物流单，预计2天到达
      ↓
[市中心] 收到配件，入库登记
      ↓
[系统] 更新省仓库存: 85-30=55根
[系统] 更新市仓库存: 12+30=42根
```

---

## 六、湖北省武汉市具体应用示例

### 示例1: 省运营中心看板展示

```
湖北省运营中心 - 实时态势
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

省内设备: 18,560台
在线率: 98.5% (全国排名第3)
本月告警: 156个 (平均2小时处理)
工单积压: 23个 (需调度支援)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

省内各市对比排行:
排名 | 城市   | 设备数 | 在线率 | 故障率
1    | 武汉   | 3,450  | 98.2% | 1.8%
2    | 宜昌   | 1,800  | 98.5% | 2.1%
3    | 襄阳   | 1,650  | 98.1% | 2.3%
4    | 黄冈   | 1,200  | 97.8% | 2.8%
5    | 荆州   | 1,100  | 98.0% | 2.5%

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

需要关注的事项:
⚠️ 武汉市工单积压8个，建议调配支援
⚠️ 黄冈市故障率上升，需分析原因
⚠️ 襄阳市配件库存不足，需调拨
```

### 示例2: 武汉市维保中心工作台

```
武汉市维保中心 - 工作台
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

市内设备: 3,450台
实时在线: 3,388台 (98.2%)
实时告警: 3个 (1个紧急)
待处理工单: 8个 (1个处理中)
今日维保: 12/18 (67%完成)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

实时告警列表:
🔴 [紧急] 困人 E1001 江汉区中山大道A栋  2分钟前
🟠 [重要] 门故障 E1008 武昌区中北路B栋  15分钟前
🟡 [一般] 温度高 E1023 洪山区光谷C栋   1小时前

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

我的工单 (进行中):
WO-001 | E1001困人救援 | 60%进度 | 张师傅
WO-002 | E1008门系统维修 | 待接单 | 未分配
WO-005 | E1020定期保养 | 待接单 | 未分配

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

市仓库存状态:
钢丝绳: 12根 ⚠️ 低于阈值(20根) - 已申请调拨
制动器: 30个 ✓ 正常
门机: 18套 ✓ 正常
控制柜: 10台 ✓ 正常
```

### 示例3: 区域化权限实例

```javascript
// 湖北省用户权限配置示例
const hubeiUsers = [
  {
    userId: 'HB001',
    username: '李明',
    role: 'province_admin',
    region: 'hubei',
    permissions: [
      'device:view:hubei',
      'device:edit:hubei',
      'alert:monitor:hubei',
      'workorder:dispatch:hubei',
      'inventory:transfer:hubei'
    ],
    accessibleCities: ['武汉', '宜昌', '襄阳', '黄冈', '荆州', '十堰', '孝感', '黄石', '咸宁', '随州', '鄂州', '荆门', '恩施']
  },
  {
    userId: 'WH001',
    username: '张师傅',
    role: 'city_operator',
    region: 'hubei',
    city: 'wuhan',
    permissions: [
      'device:view:wuhan',
      'device:monitor:realtime',
      'alert:handle:wuhan',
      'workorder:execute:wuhan',
      'inventory:consume:wuhan'
    ],
    accessibleDistricts: ['江岸', '江汉', '硚口', '汉阳', '武昌', '青山', '洪山', '东西湖', '汉南', '蔡甸', '江夏', '黄陂', '新洲']
  }
];
```

### 示例4: 地图数据范围控制

```javascript
// 地图显示范围控制
function getMapData(user) {
  switch(user.role) {
    case 'national_admin':
      // 总中心：显示全国32省市
      return {
        center: [114.31, 30.52], // 中国中心点
        zoom: 5,
        provinces: getAllProvinces()
      };
      
    case 'province_admin':
      // 省中心：显示湖北13市州
      return {
        center: [114.31, 30.52], // 武汉市中心
        zoom: 8,
        cities: ['武汉', '宜昌', '襄阳', '黄冈', '荆州', '十堰', '孝感', '黄石', '咸宁', '随州', '鄂州', '荆门', '恩施']
      };
      
    case 'city_operator':
      // 市中心：显示武汉13区
      return {
        center: [114.31, 30.52], // 武汉市中心
        zoom: 11,
        districts: ['江岸', '江汉', '硚口', '汉阳', '武昌', '青山', '洪山', '东西湖', '汉南', '蔡甸', '江夏', '黄陂', '新洲']
      };
  }
}
```

---

