# 电梯运维平台 - 后端技术架构（v0.1）

> 本文用于指导后端架构与关键技术选型落地，数据存储以 `docs/design/数据分层存储架构设计.md` 为主。

## 1. 总体架构（分层）

### 1.1 终端与接入层

- 传感器/控制器：产生运行参数与事件
- NeuronEX/边缘网关：协议适配、预处理、缓存补传
- EMQX（MQTT Broker）：消息接入与分发

### 1.2 平台服务层（后端）

后端采用 Spring Boot（单体先行、模块化拆分），核心模块：

- 采集接入：MQTT 订阅、消息解析、校验、幂等
- 规则与告警：阈值/规则判定、告警分级、SLA 计时
- 状态管理：设备最新状态计算与缓存（Redis）
- 工单与维保：工单流转、执行记录、验收归档
- 备品备件：库存/调拨/出入库/盘点/预警
- 统计分析：从 IoTDB 聚合、写入 PostgreSQL 的统计表，供报表使用
- 权限与审计：三层角色与数据范围过滤、关键操作留痕

### 1.3 数据层（分层存储）

存储分层原则（见 `docs/design/数据分层存储架构设计.md`）：

- IoTDB：全量时序（高频写入、曲线/时序查询）
- PostgreSQL：业务数据（告警、状态变更、工单、维保、备件、聚合统计）
- Redis：热数据（最新状态、在线离线、会话/token、热点榜单）

## 2. 关键数据流（从采集到展示）

### 2.1 实时采集与入库

1) 网关采集 → MQTT 上报到 EMQX  
2) 后端订阅消息 → 解析分类  
3) 全量时序写 IoTDB  
4) 告警/状态变更写 PostgreSQL  
5) 最新状态写 Redis，并触发 WebSocket 推送

### 2.2 告警分级推送（三级权限视角）

告警分级与推送范围遵循：

- 红色：国/省/市同步
- 橙色：省/市
- 黄色：市

推送通道：
- WebSocket/SSE：PC/大屏实时展示
- 第三方推送/短信：红色告警备用

## 3. API 与前端联调

- API 风格：REST（后续可补 WebSocket/SSE 事件）
- 契约：`docs/openapi.yaml`
- 返回规范：
  - 分页：`{ content, totalElements, totalPages, page, size }`
  - 错误：`{ code, message }`

## 4. 权限与数据隔离（强约束）

### 4.1 RBAC + 数据范围

- RBAC：角色（国/省/市/技术员）+ 权限点
- 数据范围：按行政区划/组织树过滤（SQL Row-Level Filter / 业务层约束）

### 4.2 审计与追踪

- 审计：告警确认/关闭、工单状态变更、库存出入库、远程控制等必须留痕
- 追踪：为每个请求/事件生成 requestId/eventId，贯穿日志与消息处理

## 5. 可靠性与幂等

- MQTT 消息：QoS 与重投递场景必须幂等（建议基于 `device_id + timestamp + type` 等生成去重键）
- 写入策略：
  - IoTDB：容忍重复写/按时间覆盖策略（按测点设计）
  - PostgreSQL：告警/状态变更写入需做去重或唯一约束
- 离线补传：边缘缓存 + 批量补传，后端需支持重放

## 6. 部署与本地开发

- 本地依赖：`deploy/docker-compose.yml`（PostgreSQL/Redis/EMQX）
- IoTDB：你已在 WSL 安装（建议后续补 `deploy/` 文档说明端口/账号/保留策略）
- 运行方式：
  - 后端（backend 分支 worktree）：`worktrees/backend/backend`
  - 前端（frontend 分支 worktree）：`worktrees/frontend/...`

## 7. 迭代路线（建议）

- v0.1：登录 + 告警列表/详情 + 工单最小流转（可联调、可演示）
- v0.2：MQTT 接入 + 分层入库 + 告警推送 + 实时状态页
- v0.3：统计分析与考核、备件全流程、跨区协同、报表导出
