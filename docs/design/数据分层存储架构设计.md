# ç”µæ¢¯è¿ç»´å¹³å° - æ•°æ®åˆ†å±‚å­˜å‚¨æ¶æ„è®¾è®¡

> **æ ¸å¿ƒé—®é¢˜**: å®æ—¶æ•°æ®ã€å‘Šè­¦æ•°æ®ã€ä¸šåŠ¡æ•°æ®åº”è¯¥å¦‚ä½•å­˜å‚¨ï¼Ÿ  
> **æŠ€æœ¯æ ˆ**: NeuronEX + EMQX + IoTDB + PostgreSQL  

---

## ä¸€ã€æ¨èæ–¹æ¡ˆï¼šåˆ†å±‚å­˜å‚¨æ¶æ„ â­

### 1.1 æ¶æ„è®¾è®¡åŸåˆ™

```
å­˜å‚¨åˆ†å±‚åŸåˆ™ï¼š
â”œâ”€â”€ æ—¶åºæ•°æ® â†’ IoTDBï¼ˆé«˜é¢‘å†™å…¥ã€æ—¶åºæŸ¥è¯¢ï¼‰
â”œâ”€â”€ ä¸šåŠ¡æ•°æ® â†’ PostgreSQLï¼ˆå…³ç³»æŸ¥è¯¢ã€äº‹åŠ¡å¤„ç†ï¼‰
â””â”€â”€ ç¼“å­˜æ•°æ® â†’ Redisï¼ˆå®æ—¶çŠ¶æ€ã€çƒ­æ•°æ®ï¼‰
```

### 1.2 å®Œæ•´æ•°æ®æµæ¶æ„å›¾ï¼ˆå«å‘Šè­¦æ¨é€ï¼‰

```mermaid
graph TB
    A[ç”µæ¢¯ä¼ æ„Ÿå™¨] -->|å·¥ä¸šåè®®| B[NeuronEXç½‘å…³]
    B -->|MQTT| C[EMQXæ¶ˆæ¯é˜Ÿåˆ—]
    
    C -->|è®¢é˜…| D[åç«¯æ•°æ®å¤„ç†æœåŠ¡]
    
    D -->|å®æ—¶æ•°æ®| E[æ•°æ®è§£ææ¨¡å—]
    E -->|è§„åˆ™å¼•æ“| F{æ•°æ®åˆ†ç±»}
    
    F -->|å…¨é‡æ—¶åºæ•°æ®| G[IoTDBæ—¶åºæ•°æ®åº“]
    F -->|å¼‚å¸¸æ•°æ®| H[å‘Šè­¦å¼•æ“]
    F -->|çŠ¶æ€å˜æ›´| I[çŠ¶æ€ç®¡ç†å™¨]
    
    H -->|è§¦å‘å‘Šè­¦| J{å‘Šè­¦çº§åˆ«åˆ¤æ–­}
    
    J -->|çº¢è‰²å‘Šè­¦| K1[ä¸‰çº§åŒæ­¥æ¨é€]
    J -->|æ©™è‰²å‘Šè­¦| K2[äºŒçº§æ¨é€]
    J -->|é»„è‰²å‘Šè­¦| K3[ä¸€çº§æ¨é€]
    
    K1 -->|æ¨é€| L1[æ€»ä¸­å¿ƒç£åŠ]
    K1 -->|æ¨é€| L2[çœä¸­å¿ƒç›‘æ§]
    K1 -->|æ¨é€| L3[å¸‚ä¸­å¿ƒå¤„ç†]
    
    K2 -->|æ¨é€| L2
    K2 -->|æ¨é€| L3
    
    K3 -->|æ¨é€| L3
    
    L1 -->|PCå¹³å°/å¤§å±| M1[WebSocketæ¨é€]
    L2 -->|PCå¹³å°/å¤§å±| M2[WebSocketæ¨é€]
    L3 -->|APP/PCå¹³å°| M3[æå…‰æ¨é€/WebSocket]
    
    H -->|å‘Šè­¦æ•°æ®| N[PostgreSQL]
    I -->|è®¾å¤‡çŠ¶æ€| N
    
    G -->|èšåˆç»Ÿè®¡| O[å®šæ—¶ä»»åŠ¡]
    O -->|å­˜å‚¨| N
    
    N -->|ä¸šåŠ¡æ•°æ®| P[å·¥å•/ç»´ä¿/é…ä»¶]
    
    D -->|å®æ—¶æ¨é€| Q[Redisç¼“å­˜]
    Q -->|WebSocket| R[å‰ç«¯å±•ç¤º]
    
    style G fill:#4CAF50
    style N fill:#2196F3
    style Q fill:#FF9800
    style K1 fill:#ff6b6b
    style K2 fill:#ffa500
    style K3 fill:#ffd700
```

---

## äºŒã€è¯¦ç»†å­˜å‚¨ç­–ç•¥

### 2.0 å‘Šè­¦æ¨é€æœºåˆ¶è¯¦è§£

#### 2.0.1 ä¸‰çº§æ¨é€æ¶æ„

```mermaid
graph LR
    A[å‘Šè­¦å¼•æ“] --> B{å‘Šè­¦çº§åˆ«}
    
    B -->|çº¢è‰²| C[ä¸‰çº§åŒæ­¥æ¨é€]
    B -->|æ©™è‰²| D[äºŒçº§æ¨é€]
    B -->|é»„è‰²| E[ä¸€çº§æ¨é€]
    
    C --> F1[æ€»ä¸­å¿ƒPCå¹³å°]
    C --> F2[çœä¸­å¿ƒPCå¹³å°]
    C --> F3[å¸‚ä¸­å¿ƒAPP]
    
    D --> F2
    D --> F3
    
    E --> F3
    
    F1 -->|WebSocket| G1[å¤§å±å®æ—¶å±•ç¤º]
    F1 -->|éŸ³æ•ˆ| G2[å£°éŸ³æé†’]
    
    F2 -->|WebSocket| H1[ç›‘æ§é¢æ¿å¼¹çª—]
    F2 -->|çŸ­ä¿¡| H2[å…³é”®äººå‘˜çŸ­ä¿¡]
    
    F3 -->|æå…‰æ¨é€| I1[æŠ€æœ¯å‘˜æ‰‹æœºé€šçŸ¥]
    F3 -->|WebSocket| I2[è°ƒåº¦å‘˜PCç«¯]
    F3 -->|çŸ­ä¿¡| I3[ç´§æ€¥çŸ­ä¿¡é€šçŸ¥]
    
    style C fill:#ff6b6b
    style D fill:#ffa500
    style E fill:#ffd700
```

#### 2.0.2 æ¨é€æ¸ é“è¯´æ˜

| æ¨é€æ¸ é“ | é€‚ç”¨åœºæ™¯ | ä¼˜å…ˆçº§ | åˆ°è¾¾ç‡ |
|---------|---------|--------|--------|
| **æå…‰æ¨é€** | å¸‚ä¸­å¿ƒæŠ€æœ¯å‘˜APP | é«˜ | 98%+ |
| **WebSocket** | PCç«¯å®æ—¶ç›‘æ§ | é«˜ | 99%+ |
| **çŸ­ä¿¡** | çº¢è‰²å‘Šè­¦å¤‡ç”¨æ¸ é“ | ä¸­ | 99%+ |
| **é‚®ä»¶** | æ—¥æŠ¥ã€å‘¨æŠ¥ | ä½ | 95%+ |
| **è¯­éŸ³ç”µè¯** | æç«¯ç´§æ€¥æƒ…å†µ | æœ€é«˜ | 100% |

#### 2.0.3 æ¨é€ä»£ç å®ç°

```java
@Service
public class AlertPushService {
    
    @Autowired
    private WebSocketServer webSocketServer;
    
    @Autowired
    private JPushClient jpushClient;
    
    @Autowired
    private SmsService smsService;
    
    /**
     * æ ¹æ®å‘Šè­¦çº§åˆ«æ¨é€é€šçŸ¥
     */
    public void pushAlertNotification(Alert alert) {
        switch (alert.getLevel()) {
            case "red":
                // çº¢è‰²å‘Šè­¦ï¼šä¸‰çº§åŒæ­¥æ¨é€
                pushToNationalCenter(alert);  // æ€»ä¸­å¿ƒ
                pushToProvinceCenter(alert);  // çœä¸­å¿ƒ
                pushToCityCenter(alert);      // å¸‚ä¸­å¿ƒ
                break;
                
            case "orange":
                // æ©™è‰²å‘Šè­¦ï¼šäºŒçº§æ¨é€
                pushToProvinceCenter(alert);
                pushToCityCenter(alert);
                break;
                
            case "yellow":
                // é»„è‰²å‘Šè­¦ï¼šä¸€çº§æ¨é€
                pushToCityCenter(alert);
                break;
        }
    }
    
    /**
     * æ¨é€ç»™æ€»ä¸­å¿ƒï¼ˆç£åŠé€šçŸ¥ï¼‰
     */
    private void pushToNationalCenter(Alert alert) {
        // WebSocketæ¨é€åˆ°PCç«¯
        webSocketServer.sendToRole("national_admin", 
            AlertMessage.builder()
                .type("critical_alert")
                .level("red")
                .content(alert.getDesc())
                .deviceId(alert.getDeviceId())
                .location(alert.getLocation())
                .build()
        );
        
        // å¤§å±éŸ³æ•ˆæé†’
        webSocketServer.sendToScreen("national_screen", 
            ScreenAlert.builder()
                .sound("critical_alert.mp3")
                .flash(true)
                .build()
        );
    }
    
    /**
     * æ¨é€ç»™çœä¸­å¿ƒï¼ˆç›‘æ§é€šçŸ¥ï¼‰
     */
    private void pushToProvinceCenter(Alert alert) {
        // WebSocketæ¨é€ï¼ˆå¼¹çª—æé†’ï¼‰
        webSocketServer.sendToRegion(alert.getProvince(),
            AlertMessage.builder()
                .type("alert_monitor")
                .level(alert.getLevel())
                .content(alert.getDesc())
                .deviceId(alert.getDeviceId())
                .location(alert.getLocation())
                .requireResponse(alert.getLevel().equals("red"))
                .build()
        );
        
        // çº¢è‰²å‘Šè­¦å‘é€çŸ­ä¿¡ç»™çœä¸­å¿ƒè´Ÿè´£äºº
        if ("red".equals(alert.getLevel())) {
            List<String> phones = getProvinceManagerPhones(alert.getProvince());
            smsService.sendBatch(phones, 
                String.format("ã€ç´§æ€¥ã€‘%så‘ç”Ÿå›°äººå‘Šè­¦ï¼Œè¯·ç«‹å³å…³æ³¨å¤„ç†è¿›åº¦ï¼", 
                    alert.getLocation())
            );
        }
    }
    
    /**
     * æ¨é€ç»™å¸‚ä¸­å¿ƒï¼ˆå¤„ç†é€šçŸ¥ï¼‰
     */
    private void pushToCityCenter(Alert alert) {
        // 1. APPæ¨é€ç»™å¸‚å†…æ‰€æœ‰æŠ€æœ¯å‘˜
        List<String> technicianIds = getTechniciansByCity(
            alert.getProvince(), 
            alert.getCity()
        );
        
        jpushClient.sendToUsers(technicianIds,
            PushNotification.builder()
                .title(getAlertTitle(alert.getLevel()))
                .content(String.format("%s - %s", 
                    alert.getLocation(), 
                    alert.getDesc()))
                .extras(Map.of(
                    "alert_id", alert.getAlertId(),
                    "device_id", alert.getDeviceId(),
                    "alert_level", alert.getLevel(),
                    "action", "open_alert_detail"
                ))
                .sound(getAlertSound(alert.getLevel()))
                .priority(getAlertPriority(alert.getLevel()))
                .build()
        );
        
        // 2. WebSocketæ¨é€ç»™è°ƒåº¦å‘˜PCç«¯
        webSocketServer.sendToCity(alert.getProvince(), alert.getCity(),
            AlertMessage.builder()
                .type("alert_process")
                .level(alert.getLevel())
                .content(alert.getDesc())
                .deviceId(alert.getDeviceId())
                .location(alert.getLocation())
                .suggestAction(getSuggestAction(alert))
                .build()
        );
        
        // 3. çº¢è‰²å‘Šè­¦ç«‹å³å‘é€çŸ­ä¿¡
        if ("red".equals(alert.getLevel())) {
            smsService.sendToNearestTechnicians(
                alert.getLocation(),
                3,  // æœ€è¿‘çš„3ä¸ªæŠ€æœ¯å‘˜
                String.format("ã€ç´§æ€¥å›°äººã€‘%sï¼Œè¯·ç«‹å³å‰å¾€å¤„ç†ï¼", 
                    alert.getLocation())
            );
        }
    }
    
    /**
     * è·å–å‘Šè­¦æ ‡é¢˜
     */
    private String getAlertTitle(String level) {
        switch (level) {
            case "red": return "ğŸ”´ ç´§æ€¥å‘Šè­¦";
            case "orange": return "ğŸŸ  é‡è¦å‘Šè­¦";
            case "yellow": return "ğŸŸ¡ ä¸€èˆ¬å‘Šè­¦";
            default: return "å‘Šè­¦é€šçŸ¥";
        }
    }
    
    /**
     * è·å–å‘Šè­¦å£°éŸ³
     */
    private String getAlertSound(String level) {
        switch (level) {
            case "red": return "emergency.mp3";      // æ€¥ä¿ƒè­¦æŠ¥å£°
            case "orange": return "important.mp3";   // æç¤ºéŸ³
            case "yellow": return "normal.mp3";      // æ™®é€šæç¤ºéŸ³
            default: return "default.mp3";
        }
    }
    
    /**
     * è·å–æ¨é€ä¼˜å…ˆçº§
     */
    private int getAlertPriority(String level) {
        switch (level) {
            case "red": return 10;      // æœ€é«˜ä¼˜å…ˆçº§
            case "orange": return 7;    // é«˜ä¼˜å…ˆçº§
            case "yellow": return 5;    // æ™®é€šä¼˜å…ˆçº§
            default: return 3;
        }
    }
}
```

#### 2.0.4 æ¨é€å¤±è´¥é‡è¯•æœºåˆ¶

```java
@Component
public class AlertPushRetryHandler {
    
    @Autowired
    private AlertPushService pushService;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * æ¨é€å¤±è´¥ååŠ å…¥é‡è¯•é˜Ÿåˆ—
     */
    public void addToRetryQueue(Alert alert, String channel, String target) {
        RetryTask task = RetryTask.builder()
            .alertId(alert.getAlertId())
            .channel(channel)
            .target(target)
            .retryCount(0)
            .maxRetries(3)
            .nextRetryTime(System.currentTimeMillis() + 60000)  // 1åˆ†é’Ÿåé‡è¯•
            .build();
        
        redisTemplate.opsForList().rightPush("alert:retry:queue", task);
    }
    
    /**
     * å®šæ—¶æ‰«æé‡è¯•é˜Ÿåˆ—
     */
    @Scheduled(fixedRate = 30000)  // æ¯30ç§’æ‰§è¡Œä¸€æ¬¡
    public void processRetryQueue() {
        List<RetryTask> tasks = redisTemplate.opsForList()
            .range("alert:retry:queue", 0, -1);
        
        long now = System.currentTimeMillis();
        
        for (RetryTask task : tasks) {
            if (now >= task.getNextRetryTime()) {
                try {
                    // é‡æ–°æ¨é€
                    pushService.retryPush(task);
                    
                    // æ¨é€æˆåŠŸï¼Œç§»é™¤ä»»åŠ¡
                    redisTemplate.opsForList().remove("alert:retry:queue", 1, task);
                    
                } catch (Exception e) {
                    // æ¨é€å¤±è´¥ï¼Œæ›´æ–°é‡è¯•æ¬¡æ•°
                    task.setRetryCount(task.getRetryCount() + 1);
                    
                    if (task.getRetryCount() >= task.getMaxRetries()) {
                        // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè®°å½•å¤±è´¥æ—¥å¿—
                        logPushFailure(task);
                        redisTemplate.opsForList().remove("alert:retry:queue", 1, task);
                    } else {
                        // ç»§ç»­é‡è¯•ï¼Œå»¶é•¿é‡è¯•æ—¶é—´
                        task.setNextRetryTime(now + 120000);  // 2åˆ†é’Ÿåé‡è¯•
                    }
                }
            }
        }
    }
}
```

#### 2.0.5 æ¨é€ç»Ÿè®¡ä¸ç›‘æ§

```java
@Service
public class AlertPushStatistics {
    
    @Autowired
    private InfluxDBTemplate influxDB;
    
    /**
     * è®°å½•æ¨é€ç»Ÿè®¡æ•°æ®
     */
    public void recordPushMetrics(String channel, String level, boolean success) {
        Point point = Point.measurement("alert_push_metrics")
            .time(System.currentTimeMillis(), TimeUnit.MILLISECONDS)
            .tag("channel", channel)
            .tag("level", level)
            .addField("success", success ? 1 : 0)
            .addField("count", 1)
            .build();
        
        influxDB.write(point);
    }
    
    /**
     * æŸ¥è¯¢æ¨é€æˆåŠŸç‡
     */
    public Map<String, Double> getPushSuccessRate(LocalDate date) {
        String query = String.format(
            "SELECT SUM(success) / SUM(count) * 100 AS success_rate " +
            "FROM alert_push_metrics " +
            "WHERE time >= '%sT00:00:00Z' AND time < '%sT00:00:00Z' " +
            "GROUP BY channel",
            date, date.plusDays(1)
        );
        
        // æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ
        return influxDB.query(query);
    }
}
```

---

## äºŒã€è¯¦ç»†å­˜å‚¨ç­–ç•¥

### 2.1 IoTDB å­˜å‚¨å†…å®¹ï¼ˆæ—¶åºæ•°æ®ï¼‰

#### å­˜å‚¨èŒƒå›´
**å…¨é‡å­˜å‚¨æ‰€æœ‰å®æ—¶é‡‡é›†çš„æ—¶åºæ•°æ®**ï¼ˆæ­£å¸¸+å¼‚å¸¸ï¼‰

#### æ•°æ®ç±»å‹
```
IoTDB æ—¶åºæ•°æ®ï¼ˆç§’çº§é‡‡é›†ï¼‰:
â”œâ”€â”€ root.elevator.E1001.floor              # å½“å‰æ¥¼å±‚
â”œâ”€â”€ root.elevator.E1001.direction          # è¿è¡Œæ–¹å‘ï¼ˆ1:ä¸Šè¡Œ -1:ä¸‹è¡Œ 0:é™æ­¢ï¼‰
â”œâ”€â”€ root.elevator.E1001.door_status        # é—¨çŠ¶æ€ï¼ˆ1:å¼€ 0:å…³ï¼‰
â”œâ”€â”€ root.elevator.E1001.speed              # å®æ—¶é€Ÿåº¦ï¼ˆm/sï¼‰
â”œâ”€â”€ root.elevator.E1001.load               # å½“å‰è½½é‡ï¼ˆkgï¼‰
â”œâ”€â”€ root.elevator.E1001.temperature        # æ¸©åº¦ï¼ˆÂ°Cï¼‰
â”œâ”€â”€ root.elevator.E1001.vibration          # æŒ¯åŠ¨å€¼ï¼ˆmm/sï¼‰
â”œâ”€â”€ root.elevator.E1001.power              # åŠŸç‡ï¼ˆkWï¼‰
â”œâ”€â”€ root.elevator.E1001.voltage            # ç”µå‹ï¼ˆVï¼‰
â””â”€â”€ root.elevator.E1001.current            # ç”µæµï¼ˆAï¼‰
```

#### å­˜å‚¨ç†ç”±
âœ… **é«˜é¢‘å†™å…¥**ï¼šæ¯ç§’1æ¬¡é‡‡é›†ï¼ŒIoTDBä¸“ä¸ºæ—¶åºä¼˜åŒ–  
âœ… **å†å²æŸ¥è¯¢**ï¼šç”»è¶‹åŠ¿æ›²çº¿ã€èƒ½è€—åˆ†æ  
âœ… **æ•°æ®å‹ç¼©**ï¼šIoTDBå‹ç¼©ç‡é«˜ï¼Œå­˜å‚¨æˆæœ¬ä½  
âœ… **æ—¶é—´èŒƒå›´æŸ¥è¯¢**ï¼šå¿«é€ŸæŸ¥è¯¢æŸæ—¶é—´æ®µæ•°æ®  

#### æ•°æ®ä¿ç•™ç­–ç•¥
```sql
-- åŸå§‹æ•°æ®ä¿ç•™30å¤©
CREATE TIMESERIES root.elevator.E1001.temperature 
WITH TTL=2592000000;  -- 30å¤©ï¼ˆæ¯«ç§’ï¼‰

-- åˆ†é’Ÿçº§èšåˆæ•°æ®ä¿ç•™1å¹´
-- å°æ—¶çº§èšåˆæ•°æ®ä¿ç•™3å¹´
-- å¤©çº§èšåˆæ•°æ®æ°¸ä¹…ä¿ç•™
```

---

### 2.2 PostgreSQL å­˜å‚¨å†…å®¹ï¼ˆä¸šåŠ¡æ•°æ®ï¼‰

#### å­˜å‚¨èŒƒå›´
**ä»…å­˜å‚¨ä¸šåŠ¡å…³é”®æ•°æ®**ï¼ˆå‘Šè­¦ã€çŠ¶æ€å˜æ›´ã€èšåˆç»Ÿè®¡ï¼‰

#### 2.2.1 å‘Šè­¦æ•°æ®è¡¨ `alerts`

```sql
CREATE TABLE alerts (
    id BIGSERIAL PRIMARY KEY,
    alert_id VARCHAR(50) UNIQUE NOT NULL,          -- å‘Šè­¦IDï¼ˆå”¯ä¸€ï¼‰
    device_id VARCHAR(50) NOT NULL,                -- è®¾å¤‡ID
    alert_level VARCHAR(20) NOT NULL,              -- å‘Šè­¦çº§åˆ«ï¼ˆred/orange/yellowï¼‰
    alert_type VARCHAR(50) NOT NULL,               -- å‘Šè­¦ç±»å‹ï¼ˆtrapped/door_fault/temperatureï¼‰
    alert_desc TEXT,                               -- å‘Šè­¦æè¿°
    trigger_value JSONB,                           -- è§¦å‘å€¼ï¼ˆåŸå§‹æ•°æ®å¿«ç…§ï¼‰
    threshold_value JSONB,                         -- é˜ˆå€¼è®¾ç½®
    location VARCHAR(200),                         -- è®¾å¤‡ä½ç½®
    province VARCHAR(50),                          -- çœä»½
    city VARCHAR(50),                              -- åŸå¸‚
    status VARCHAR(20) DEFAULT 'pending',          -- çŠ¶æ€ï¼ˆpending/processing/closedï¼‰
    created_at TIMESTAMP DEFAULT NOW(),            -- åˆ›å»ºæ—¶é—´
    updated_at TIMESTAMP DEFAULT NOW(),            -- æ›´æ–°æ—¶é—´
    processed_at TIMESTAMP,                        -- å¤„ç†æ—¶é—´
    processed_by VARCHAR(50),                      -- å¤„ç†äºº
    closed_at TIMESTAMP,                           -- å…³é—­æ—¶é—´
    response_time INTEGER,                         -- å“åº”æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    processing_time INTEGER,                       -- å¤„ç†æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    work_order_id VARCHAR(50),                     -- å…³è”å·¥å•
    remark TEXT,                                   -- å¤‡æ³¨
    
    INDEX idx_device_id (device_id),
    INDEX idx_alert_level (alert_level),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_province_city (province, city)
);
```

**å­˜å‚¨ç†ç”±**ï¼š
- âœ… å‘Šè­¦éœ€è¦å…³è”å·¥å•ã€ç»´ä¿è®°å½•
- âœ… éœ€è¦ç»Ÿè®¡åˆ†æï¼ˆå„çº§å‘Šè­¦æ•°é‡ã€å¤„ç†æ—¶æ•ˆï¼‰
- âœ… éœ€è¦è¿½æº¯å¤„ç†è¿‡ç¨‹
- âœ… ä¸éœ€è¦å­˜å‚¨å‘Šè­¦æ—¶åˆ»çš„æ‰€æœ‰ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆIoTDBå·²æœ‰ï¼‰

#### 2.2.2 è®¾å¤‡çŠ¶æ€å˜æ›´è¡¨ `device_status_log`

```sql
CREATE TABLE device_status_log (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL,
    old_status VARCHAR(20),                        -- æ—§çŠ¶æ€
    new_status VARCHAR(20) NOT NULL,               -- æ–°çŠ¶æ€ï¼ˆonline/offline/running/stopped/fault/maintenanceï¼‰
    change_reason VARCHAR(100),                    -- å˜æ›´åŸå› 
    trigger_source VARCHAR(50),                    -- è§¦å‘æºï¼ˆauto/manual/alertï¼‰
    created_at TIMESTAMP DEFAULT NOW(),
    
    INDEX idx_device_id (device_id),
    INDEX idx_created_at (created_at)
);
```

**å­˜å‚¨ç†ç”±**ï¼š
- âœ… åªè®°å½•çŠ¶æ€**å˜æ›´**æ—¶åˆ»ï¼ˆä¸æ˜¯æ¯ç§’è®°å½•ï¼‰
- âœ… ç”¨äºç»Ÿè®¡è®¾å¤‡åœ¨çº¿ç‡ã€æ•…éšœç‡
- âœ… ç”¨äºè¿½æº¯è®¾å¤‡çŠ¶æ€å†å²

#### 2.2.3 è®¾å¤‡ç»Ÿè®¡æ•°æ®è¡¨ `device_statistics`

```sql
CREATE TABLE device_statistics (
    id BIGSERIAL PRIMARY KEY,
    device_id VARCHAR(50) NOT NULL,
    stat_date DATE NOT NULL,                       -- ç»Ÿè®¡æ—¥æœŸ
    run_time INTEGER DEFAULT 0,                    -- è¿è¡Œæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    stop_time INTEGER DEFAULT 0,                   -- åœæ­¢æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    fault_time INTEGER DEFAULT 0,                  -- æ•…éšœæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰
    run_count INTEGER DEFAULT 0,                   -- è¿è¡Œæ¬¡æ•°
    fault_count INTEGER DEFAULT 0,                 -- æ•…éšœæ¬¡æ•°
    alert_count INTEGER DEFAULT 0,                 -- å‘Šè­¦æ¬¡æ•°
    energy_consumption DECIMAL(10,2),              -- èƒ½è€—ï¼ˆkWhï¼‰
    avg_temperature DECIMAL(5,2),                  -- å¹³å‡æ¸©åº¦
    max_temperature DECIMAL(5,2),                  -- æœ€é«˜æ¸©åº¦
    avg_load DECIMAL(8,2),                         -- å¹³å‡è½½é‡
    max_load DECIMAL(8,2),                         -- æœ€å¤§è½½é‡
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(device_id, stat_date),
    INDEX idx_device_id (device_id),
    INDEX idx_stat_date (stat_date)
);
```

**å­˜å‚¨ç†ç”±**ï¼š
- âœ… ä»IoTDBèšåˆè€Œæ¥ï¼ˆå®šæ—¶ä»»åŠ¡æ¯æ—¥å‡Œæ™¨æ‰§è¡Œï¼‰
- âœ… ç”¨äºæŠ¥è¡¨ç”Ÿæˆã€æ•°æ®åˆ†æ
- âœ… é¿å…é¢‘ç¹æŸ¥è¯¢IoTDBåŸå§‹æ•°æ®

---

### 2.3 Redis å­˜å‚¨å†…å®¹ï¼ˆç¼“å­˜æ•°æ®ï¼‰

#### å­˜å‚¨èŒƒå›´
**å®æ—¶çŠ¶æ€ã€çƒ­æ•°æ®ã€ä¼šè¯æ•°æ®**

```
Redis ç¼“å­˜æ•°æ®:
â”œâ”€â”€ device:E1001:realtime           # è®¾å¤‡æœ€æ–°æ•°æ®ï¼ˆTTL=10sï¼‰
â”‚   â””â”€â”€ {floor: 12, speed: 2.5, temperature: 25, ...}
â”‚
â”œâ”€â”€ device:E1001:status             # è®¾å¤‡çŠ¶æ€ï¼ˆonline/offlineï¼‰
â”‚   â””â”€â”€ {status: "online", last_heartbeat: 1704614400}
â”‚
â”œâ”€â”€ alert:active                    # æ´»è·ƒå‘Šè­¦åˆ—è¡¨ï¼ˆSorted Setï¼‰
â”‚   â””â”€â”€ [ALT-001, ALT-002, ...]
â”‚
â””â”€â”€ user:session:{token}            # ç”¨æˆ·ä¼šè¯ï¼ˆTTL=2hï¼‰
    â””â”€â”€ {user_id, role, region, ...}
```

**å­˜å‚¨ç†ç”±**ï¼š
- âœ… å®æ—¶ç›‘æ§é¡µé¢ä¸ç”¨é¢‘ç¹æŸ¥IoTDB
- âœ… é™ä½æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
- âœ… WebSocketæ¨é€ä½¿ç”¨

---

## ä¸‰ã€æ•°æ®æµè½¬è¯¦ç»†è®¾è®¡

### 3.1 æ­£å¸¸æ•°æ®æµç¨‹

```mermaid
sequenceDiagram
    participant N as NeuronEX
    participant E as EMQX
    participant B as åç«¯æœåŠ¡
    participant I as IoTDB
    participant R as Redis
    participant W as WebSocket
    
    Note over N: æ¯ç§’é‡‡é›†ä¸€æ¬¡
    N->>E: MQTTå‘å¸ƒæ•°æ®
    E->>B: è®¢é˜…æ¶ˆè´¹
    
    B->>B: æ•°æ®è§£æ
    B->>B: è§„åˆ™å¼•æ“åˆ¤æ–­
    
    Note over B: æ­£å¸¸æ•°æ®
    
    par å¹¶è¡Œå†™å…¥
        B->>I: å†™å…¥æ—¶åºæ•°æ®
        B->>R: æ›´æ–°ç¼“å­˜ï¼ˆæœ€æ–°å€¼ï¼‰
    end
    
    R->>W: æ¨é€ç»™å‰ç«¯
    W->>W: å®æ—¶ç›‘æ§é¡µé¢æ›´æ–°
```

### 3.2 å¼‚å¸¸æ•°æ®æµç¨‹ï¼ˆè§¦å‘å‘Šè­¦+æ¨é€ï¼‰

```mermaid
sequenceDiagram
    participant N as NeuronEX
    participant E as EMQX
    participant B as åç«¯æœåŠ¡
    participant I as IoTDB
    participant P as PostgreSQL
    participant A as å‘Šè­¦å¼•æ“
    participant R as Redis
    participant Push as æ¨é€æœåŠ¡
    participant T as æ€»ä¸­å¿ƒ
    participant Prov as çœä¸­å¿ƒ
    participant C as å¸‚ä¸­å¿ƒ
    
    Note over N: æ¸©åº¦31Â°C
    N->>E: MQTTå‘å¸ƒæ•°æ®
    E->>B: è®¢é˜…æ¶ˆè´¹
    
    B->>B: æ•°æ®è§£æ
    B->>B: è§„åˆ™å¼•æ“åˆ¤æ–­
    
    Note over B: å¼‚å¸¸æ•°æ®ï¼ˆæ¸©åº¦>30Â°Cï¼‰
    
    par å¹¶è¡Œå¤„ç†
        B->>I: å†™å…¥æ—¶åºæ•°æ®ï¼ˆæ­£å¸¸å†™å…¥ï¼‰
        B->>A: è§¦å‘å‘Šè­¦å¼•æ“
    end
    
    A->>A: ç”Ÿæˆå‘Šè­¦è®°å½•
    A->>A: åˆ¤æ–­å‘Šè­¦çº§åˆ«: é»„è‰²
    A->>P: å†™å…¥alertsè¡¨
    P->>P: INSERTå‘Šè­¦æ•°æ®
    
    A->>R: åŠ å…¥æ´»è·ƒå‘Šè­¦åˆ—è¡¨
    
    Note over A: æ ¹æ®çº§åˆ«æ¨é€
    A->>Push: æ¨é€è¯·æ±‚ï¼ˆé»„è‰²å‘Šè­¦ï¼‰
    
    Push->>C: ä¸€çº§æ¨é€ï¼ˆä»…å¸‚ä¸­å¿ƒï¼‰
    Note over C: APPæ¨é€ + WebSocket
    
    C->>C: æŠ€æœ¯å‘˜æ”¶åˆ°é€šçŸ¥
    
    Note over N: å‡è®¾è§¦å‘å›°äººï¼ˆçº¢è‰²å‘Šè­¦ï¼‰
    N->>E: å›°äººä¼ æ„Ÿå™¨è§¦å‘
    E->>B: è®¢é˜…æ¶ˆè´¹
    
    B->>B: è§„åˆ™å¼•æ“åˆ¤æ–­
    Note over B: å¼‚å¸¸æ•°æ®ï¼ˆå›°äººï¼‰
    
    par å¹¶è¡Œå¤„ç†
        B->>I: å†™å…¥æ—¶åºæ•°æ®
        B->>A: è§¦å‘å‘Šè­¦å¼•æ“
    end
    
    A->>A: ç”Ÿæˆå‘Šè­¦è®°å½•
    A->>A: åˆ¤æ–­å‘Šè­¦çº§åˆ«: çº¢è‰²
    A->>P: å†™å…¥alertsè¡¨
    
    A->>R: åŠ å…¥æ´»è·ƒå‘Šè­¦åˆ—è¡¨
    
    Note over A: ä¸‰çº§åŒæ­¥æ¨é€
    A->>Push: æ¨é€è¯·æ±‚ï¼ˆçº¢è‰²å‘Šè­¦ï¼‰
    
    par ä¸‰çº§åŒæ­¥æ¨é€
        Push->>T: WebSocket + éŸ³æ•ˆ
        Push->>Prov: WebSocket + çŸ­ä¿¡
        Push->>C: APPæ¨é€ + WebSocket + çŸ­ä¿¡
    end
    
    T->>T: æ€»ä¸­å¿ƒå¤§å±é—ªçƒæç¤º
    Prov->>Prov: çœä¸­å¿ƒå¼¹çª—ç›‘æ§
    C->>C: å¸‚ä¸­å¿ƒç«‹å³å“åº”
    
    Note over C: 30åˆ†é’Ÿå†…å¿…é¡»å“åº”<br/>å¦åˆ™å‡çº§çœä¸­å¿ƒ
```

### 3.3 å®šæ—¶èšåˆæµç¨‹

```mermaid
sequenceDiagram
    participant C as å®šæ—¶ä»»åŠ¡ï¼ˆCronï¼‰
    participant I as IoTDB
    participant P as PostgreSQL
    
    Note over C: æ¯æ—¥å‡Œæ™¨2:00æ‰§è¡Œ
    C->>I: æŸ¥è¯¢æ˜¨æ—¥æ•°æ®
    
    Note over I: SELECT AVG/MAX/MIN/SUM<br/>FROM root.elevator.E1001<br/>WHERE time >= '2025-01-05 00:00:00'<br/>AND time < '2025-01-06 00:00:00'
    
    I->>C: è¿”å›èšåˆç»“æœ
    
    C->>C: è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
    C->>P: å†™å…¥device_statisticsè¡¨
    
    Note over P: UPSERTç»Ÿè®¡æ•°æ®
    P->>P: æ•°æ®å­˜å‚¨å®Œæˆ
```

---

## å››ã€æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### 4.1 ä¸‰ç§æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | IoTDB | PostgreSQL | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|-------|-----------|------|------|--------|
| **æ–¹æ¡ˆA**<br/>å…¨é‡å­˜ä¸¤ä»½ | âœ… å…¨é‡æ—¶åº | âœ… å…¨é‡æ˜ç»† | æ•°æ®å†—ä½™å¤‡ä»½ | å­˜å‚¨æµªè´¹ã€å†™å…¥å‹åŠ›å¤§ | â­ |
| **æ–¹æ¡ˆB**<br/>ä»…å­˜å‘Šè­¦ | âœ… å…¨é‡æ—¶åº | âœ… ä»…å‘Šè­¦ | å­˜å‚¨åˆç† | æ— æ³•å…³è”æŸ¥è¯¢æ­£å¸¸æ•°æ® | â­â­â­ |
| **æ–¹æ¡ˆC**<br/>åˆ†å±‚å­˜å‚¨ï¼ˆæ¨èï¼‰ | âœ… å…¨é‡æ—¶åº | âœ… å‘Šè­¦<br/>âœ… çŠ¶æ€å˜æ›´<br/>âœ… èšåˆç»Ÿè®¡ | å„å¸å…¶èŒã€æ€§èƒ½æœ€ä¼˜ | æ¶æ„ç¨å¤æ‚ | â­â­â­â­â­ |

### 4.2 ä¸ºä»€ä¹ˆä¸æŠŠæ­£å¸¸æ•°æ®ä¹Ÿå­˜PostgreSQLï¼Ÿ

#### âŒ é—®é¢˜1ï¼šå†™å…¥å‹åŠ›å·¨å¤§
```
å‡è®¾ï¼š1000å°ç”µæ¢¯ï¼Œæ¯ç§’é‡‡é›†1æ¬¡ï¼Œ10ä¸ªæŒ‡æ ‡
å†™å…¥QPS = 1000 * 1 * 10 = 10,000 QPS

PostgreSQLéš¾ä»¥æ‰¿å—å¦‚æ­¤é«˜é¢‘çš„æ’å…¥æ“ä½œ
è€ŒIoTDBä¸“ä¸ºæ—¶åºæ•°æ®ä¼˜åŒ–ï¼Œè½»æ¾æ”¯æŒç™¾ä¸‡çº§å†™å…¥
```

#### âŒ é—®é¢˜2ï¼šå­˜å‚¨æˆæœ¬é«˜
```
PostgreSQLæ— å‹ç¼©ï¼Œ1å¹´æ•°æ®é‡ï¼š
1000å° * 86400ç§’/å¤© * 365å¤© * 10æŒ‡æ ‡ * 100å­—èŠ‚ â‰ˆ 31TB

IoTDBå‹ç¼©åï¼ˆå‹ç¼©æ¯”1:10ï¼‰ï¼š
31TB / 10 â‰ˆ 3.1TB
```

#### âŒ é—®é¢˜3ï¼šæŸ¥è¯¢æ•ˆç‡ä½
```
-- æŸ¥è¯¢æŸè®¾å¤‡24å°æ—¶æ¸©åº¦æ›²çº¿
-- PostgreSQL: å…¨è¡¨æ‰«æ 86400æ¡è®°å½•
-- IoTDB: æ—¶åºç´¢å¼•ï¼Œæ¯«ç§’çº§è¿”å›
```

---

## äº”ã€å®æ–½å»ºè®®

### 5.1 æ•°æ®å†™å…¥ä»£ç ç¤ºä¾‹

```java
@Service
public class DataProcessService {
    
    @Autowired
    private IoTDBTemplate iotdbTemplate;
    
    @Autowired
    private AlertService alertService;
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * å¤„ç†EMQXæ¨é€çš„æ•°æ®
     */
    public void processDeviceData(DeviceData data) {
        // 1. å†™å…¥IoTDBï¼ˆå…¨é‡æ—¶åºæ•°æ®ï¼‰
        writeToIoTDB(data);
        
        // 2. æ›´æ–°Redisç¼“å­˜ï¼ˆæœ€æ–°å€¼ï¼‰
        updateRedisCache(data);
        
        // 3. è§„åˆ™å¼•æ“åˆ¤æ–­æ˜¯å¦å¼‚å¸¸
        if (isAbnormal(data)) {
            // è§¦å‘å‘Šè­¦ï¼Œå†™å…¥PostgreSQL
            alertService.createAlert(data);
        }
        
        // 4. çŠ¶æ€å˜æ›´æ£€æµ‹
        if (isStatusChanged(data)) {
            // å†™å…¥PostgreSQLçŠ¶æ€å˜æ›´è¡¨
            logStatusChange(data);
        }
    }
    
    /**
     * å†™å…¥IoTDBæ—¶åºæ•°æ®
     */
    private void writeToIoTDB(DeviceData data) {
        String devicePath = "root.elevator." + data.getDeviceId();
        
        List<Measurement> measurements = Arrays.asList(
            new Measurement(devicePath + ".floor", data.getFloor()),
            new Measurement(devicePath + ".speed", data.getSpeed()),
            new Measurement(devicePath + ".temperature", data.getTemperature()),
            new Measurement(devicePath + ".load", data.getLoad()),
            new Measurement(devicePath + ".power", data.getPower())
        );
        
        iotdbTemplate.insertRecord(devicePath, data.getTimestamp(), measurements);
    }
    
    /**
     * è§„åˆ™å¼•æ“åˆ¤æ–­å¼‚å¸¸
     */
    private boolean isAbnormal(DeviceData data) {
        // æ¸©åº¦é˜ˆå€¼
        if (data.getTemperature() > 30) {
            return true;
        }
        
        // æŒ¯åŠ¨é˜ˆå€¼
        if (data.getVibration() > 0.1) {
            return true;
        }
        
        // é€Ÿåº¦å¼‚å¸¸
        if (data.getSpeed() > 3.0) {
            return true;
        }
        
        return false;
    }
}
```

### 5.2 å®šæ—¶èšåˆä»»åŠ¡ç¤ºä¾‹

```java
@Component
public class DataAggregationTask {
    
    @Autowired
    private IoTDBTemplate iotdbTemplate;
    
    @Autowired
    private DeviceStatisticsMapper statisticsMapper;
    
    /**
     * æ¯æ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œèšåˆä»»åŠ¡
     */
    @Scheduled(cron = "0 0 2 * * ?")
    public void aggregateDailyStatistics() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        
        // æŸ¥è¯¢æ‰€æœ‰è®¾å¤‡åˆ—è¡¨
        List<String> deviceIds = getDeviceList();
        
        for (String deviceId : deviceIds) {
            // ä»IoTDBèšåˆæ•°æ®
            DeviceStatistics stats = aggregateFromIoTDB(deviceId, yesterday);
            
            // å†™å…¥PostgreSQL
            statisticsMapper.upsert(stats);
        }
    }
    
    /**
     * ä»IoTDBèšåˆç»Ÿè®¡æ•°æ®
     */
    private DeviceStatistics aggregateFromIoTDB(String deviceId, LocalDate date) {
        String sql = String.format(
            "SELECT " +
            "  AVG(temperature) AS avg_temp, " +
            "  MAX(temperature) AS max_temp, " +
            "  AVG(load) AS avg_load, " +
            "  SUM(power) AS total_energy " +
            "FROM root.elevator.%s " +
            "WHERE time >= '%s 00:00:00' AND time < '%s 00:00:00'",
            deviceId, date, date.plusDays(1)
        );
        
        // æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»Ÿè®¡ç»“æœ
        return iotdbTemplate.queryForObject(sql, DeviceStatistics.class);
    }
}
```

---

## å…­ã€æŸ¥è¯¢åœºæ™¯ç¤ºä¾‹

### 6.1 å®æ—¶ç›‘æ§æŸ¥è¯¢

```java
/**
 * æŸ¥è¯¢è®¾å¤‡æœ€æ–°æ•°æ®ï¼ˆä»Redisï¼‰
 */
public DeviceRealtimeData getRealtimeData(String deviceId) {
    String key = "device:" + deviceId + ":realtime";
    return redisTemplate.opsForValue().get(key);
}
```

### 6.2 å†å²æ›²çº¿æŸ¥è¯¢

```java
/**
 * æŸ¥è¯¢è®¾å¤‡24å°æ—¶æ¸©åº¦æ›²çº¿ï¼ˆä»IoTDBï¼‰
 */
public List<TimeValue> getTemperatureCurve(String deviceId, LocalDateTime start, LocalDateTime end) {
    String sql = String.format(
        "SELECT time, temperature FROM root.elevator.%s " +
        "WHERE time >= %d AND time <= %d",
        deviceId, start.toEpochMilli(), end.toEpochMilli()
    );
    
    return iotdbTemplate.query(sql);
}
```

### 6.3 å‘Šè­¦åˆ—è¡¨æŸ¥è¯¢

```sql
-- æŸ¥è¯¢è®¾å¤‡å‘Šè­¦å†å²ï¼ˆä»PostgreSQLï¼‰
SELECT 
    a.alert_id,
    a.alert_level,
    a.alert_type,
    a.created_at,
    a.status,
    w.work_order_id
FROM alerts a
LEFT JOIN work_orders w ON a.work_order_id = w.work_order_id
WHERE a.device_id = 'E1001'
  AND a.created_at >= '2025-01-01'
ORDER BY a.created_at DESC;
```

### 6.4 ç»Ÿè®¡æŠ¥è¡¨æŸ¥è¯¢

```sql
-- æŸ¥è¯¢è®¾å¤‡æœˆåº¦ç»Ÿè®¡ï¼ˆä»PostgreSQLï¼‰
SELECT 
    device_id,
    SUM(run_time) AS total_run_time,
    SUM(fault_count) AS total_fault_count,
    AVG(avg_temperature) AS avg_temperature,
    SUM(energy_consumption) AS total_energy
FROM device_statistics
WHERE stat_date >= '2025-01-01' AND stat_date < '2025-02-01'
GROUP BY device_id;
```

---

## ä¸ƒã€æ•°æ®ä¿ç•™ç­–ç•¥

### 7.1 IoTDB æ•°æ®ä¿ç•™

```
åŸå§‹æ•°æ®ï¼ˆ1ç§’çº§ï¼‰ï¼šä¿ç•™30å¤©
â”œâ”€â”€ 30å¤©åè‡ªåŠ¨åˆ é™¤
â””â”€â”€ ç”¨äºå®æ—¶ç›‘æ§ã€çŸ­æœŸåˆ†æ

åˆ†é’Ÿçº§èšåˆï¼šä¿ç•™1å¹´
â”œâ”€â”€ ä»åŸå§‹æ•°æ®èšåˆè€Œæ¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
â””â”€â”€ ç”¨äºå‘¨/æœˆè¶‹åŠ¿åˆ†æ

å°æ—¶çº§èšåˆï¼šä¿ç•™3å¹´
â””â”€â”€ ç”¨äºå­£åº¦/å¹´åº¦åˆ†æ

å¤©çº§èšåˆï¼šæ°¸ä¹…ä¿ç•™
â””â”€â”€ ç”¨äºå†å²å¯¹æ¯”ã€é•¿æœŸåˆ†æ
```

### 7.2 PostgreSQL æ•°æ®ä¿ç•™

```
å‘Šè­¦æ•°æ®ï¼šæ°¸ä¹…ä¿ç•™
â”œâ”€â”€ ç”¨äºè¿½æº¯ã€å®¡è®¡
â””â”€â”€ å¯å®šæœŸå½’æ¡£åˆ°å†å²è¡¨

çŠ¶æ€å˜æ›´æ—¥å¿—ï¼šä¿ç•™1å¹´
â””â”€â”€ 1å¹´åå½’æ¡£åˆ°å†·å­˜å‚¨

ç»Ÿè®¡æ•°æ®ï¼šæ°¸ä¹…ä¿ç•™
â””â”€â”€ æ•°æ®é‡å°ï¼Œé•¿æœŸä»·å€¼é«˜
```

---

## ä¹ã€å‘Šè­¦æ¨é€é…ç½®ä¸æœ€ä½³å®è·µ

### 9.1 æ¨é€æ¸ é“é…ç½®

#### 9.1.1 æå…‰æ¨é€é…ç½®ï¼ˆAPPï¼‰

```yaml
# application.yml
jpush:
  app-key: your_app_key
  master-secret: your_master_secret
  apns-production: true  # ç”Ÿäº§ç¯å¢ƒ
  time-to-live: 86400    # ç¦»çº¿æ¶ˆæ¯ä¿ç•™æ—¶é—´ï¼ˆç§’ï¼‰
  
  # ä¸åŒçº§åˆ«å‘Šè­¦çš„æ¨é€é…ç½®
  alert-config:
    red:
      sound: emergency.mp3
      priority: 10
      badge: +1
      vibrate: true
    orange:
      sound: important.mp3
      priority: 7
      badge: +1
      vibrate: true
    yellow:
      sound: normal.mp3
      priority: 5
      badge: +1
      vibrate: false
```

#### 9.1.2 WebSocketé…ç½®

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(alertWebSocketHandler(), "/ws/alert")
                .setAllowedOrigins("*")
                .addInterceptors(new WebSocketHandshakeInterceptor());
    }
    
    @Bean
    public AlertWebSocketHandler alertWebSocketHandler() {
        return new AlertWebSocketHandler();
    }
}

@Component
public class AlertWebSocketHandler extends TextWebSocketHandler {
    
    // å­˜å‚¨æ‰€æœ‰è¿æ¥çš„ä¼šè¯
    private static Map<String, WebSocketSession> sessions = new ConcurrentHashMap<>();
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        String userId = getUserIdFromSession(session);
        sessions.put(userId, session);
        log.info("WebSocketè¿æ¥å»ºç«‹: {}", userId);
    }
    
    /**
     * å‘é€å‘Šè­¦æ¶ˆæ¯
     */
    public void sendAlert(String userId, AlertMessage message) {
        WebSocketSession session = sessions.get(userId);
        if (session != null && session.isOpen()) {
            try {
                session.sendMessage(new TextMessage(JSON.toJSONString(message)));
            } catch (IOException e) {
                log.error("WebSocketæ¨é€å¤±è´¥: {}", userId, e);
            }
        }
    }
    
    /**
     * ç¾¤å‘å‘Šè­¦æ¶ˆæ¯ï¼ˆæŒ‰è§’è‰²ï¼‰
     */
    public void broadcastToRole(String role, AlertMessage message) {
        sessions.entrySet().stream()
            .filter(entry -> hasRole(entry.getKey(), role))
            .forEach(entry -> {
                try {
                    entry.getValue().sendMessage(
                        new TextMessage(JSON.toJSONString(message))
                    );
                } catch (IOException e) {
                    log.error("WebSocketæ¨é€å¤±è´¥: {}", entry.getKey(), e);
                }
            });
    }
}
```

#### 9.1.3 çŸ­ä¿¡æ¨é€é…ç½®

```yaml
# çŸ­ä¿¡æœåŠ¡é…ç½®ï¼ˆé˜¿é‡Œäº‘çŸ­ä¿¡ï¼‰
aliyun:
  sms:
    access-key-id: your_access_key
    access-key-secret: your_access_secret
    sign-name: ç”µæ¢¯è¿ç»´å¹³å°
    
    # çŸ­ä¿¡æ¨¡æ¿
    templates:
      red-alert: SMS_123456789      # ç´§æ€¥å‘Šè­¦æ¨¡æ¿
      orange-alert: SMS_987654321   # é‡è¦å‘Šè­¦æ¨¡æ¿
      
    # å‘é€é™åˆ¶
    rate-limit:
      per-phone: 10                 # æ¯ä¸ªæ‰‹æœºå·æ¯å¤©æœ€å¤š10æ¡
      per-minute: 5                 # æ¯åˆ†é’Ÿæœ€å¤š5æ¡
```

### 9.2 æ¨é€æœ€ä½³å®è·µ

#### 9.2.1 æ¨é€ä¼˜å…ˆçº§ç­–ç•¥

```
æ¨é€ä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š
1. çº¢è‰²å‘Šè­¦ â†’ æå…‰æ¨é€ï¼ˆå®æ—¶ï¼‰ + çŸ­ä¿¡ï¼ˆç«‹å³ï¼‰ + WebSocketï¼ˆå®æ—¶ï¼‰
2. æ©™è‰²å‘Šè­¦ â†’ æå…‰æ¨é€ï¼ˆå®æ—¶ï¼‰ + WebSocketï¼ˆå®æ—¶ï¼‰ + çŸ­ä¿¡ï¼ˆå»¶è¿Ÿ5åˆ†é’Ÿï¼‰
3. é»„è‰²å‘Šè­¦ â†’ æå…‰æ¨é€ï¼ˆå®æ—¶ï¼‰ + WebSocketï¼ˆå®æ—¶ï¼‰
```

#### 9.2.2 æ¨é€é˜²éªšæ‰°æœºåˆ¶

```java
@Service
public class AlertPushThrottler {
    
    @Autowired
    private RedisTemplate redisTemplate;
    
    /**
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ¨é€ï¼ˆé˜²æ­¢é¢‘ç¹æ¨é€åŒä¸€å‘Šè­¦ï¼‰
     */
    public boolean canPush(String deviceId, String alertType, String userId) {
        String key = String.format("push:throttle:%s:%s:%s", 
            deviceId, alertType, userId);
        
        // æ£€æŸ¥Redisä¸­æ˜¯å¦å­˜åœ¨
        Boolean exists = redisTemplate.hasKey(key);
        
        if (Boolean.TRUE.equals(exists)) {
            // 10åˆ†é’Ÿå†…åŒä¸€è®¾å¤‡åŒä¸€ç±»å‹å‘Šè­¦ä¸é‡å¤æ¨é€ç»™åŒä¸€ç”¨æˆ·
            return false;
        }
        
        // è®¾ç½®10åˆ†é’Ÿè¿‡æœŸ
        redisTemplate.opsForValue().set(key, "1", 10, TimeUnit.MINUTES);
        return true;
    }
    
    /**
     * æ£€æŸ¥çŸ­ä¿¡å‘é€é¢‘ç‡ï¼ˆé˜²æ­¢éªšæ‰°ï¼‰
     */
    public boolean canSendSms(String phone) {
        String key = "sms:limit:" + phone;
        
        Long count = redisTemplate.opsForValue().increment(key);
        
        if (count == 1) {
            // ç¬¬ä¸€æ¬¡ï¼Œè®¾ç½®24å°æ—¶è¿‡æœŸ
            redisTemplate.expire(key, 24, TimeUnit.HOURS);
        }
        
        // æ¯ä¸ªæ‰‹æœºå·æ¯å¤©æœ€å¤š10æ¡çŸ­ä¿¡
        return count <= 10;
    }
}
```

#### 9.2.3 æ¨é€åˆ°è¾¾ç‡ç›‘æ§

```java
@Component
public class PushMonitor {
    
    @Autowired
    private PrometheusRegistry prometheusRegistry;
    
    // æ¨é€æˆåŠŸç‡
    private Counter pushSuccessCounter = Counter.build()
        .name("alert_push_success_total")
        .help("å‘Šè­¦æ¨é€æˆåŠŸæ€»æ•°")
        .labelNames("channel", "level")
        .register(prometheusRegistry);
    
    // æ¨é€å¤±è´¥ç‡
    private Counter pushFailureCounter = Counter.build()
        .name("alert_push_failure_total")
        .help("å‘Šè­¦æ¨é€å¤±è´¥æ€»æ•°")
        .labelNames("channel", "level", "reason")
        .register(prometheusRegistry);
    
    // æ¨é€è€—æ—¶
    private Histogram pushDuration = Histogram.build()
        .name("alert_push_duration_seconds")
        .help("å‘Šè­¦æ¨é€è€—æ—¶")
        .labelNames("channel", "level")
        .register(prometheusRegistry);
    
    /**
     * è®°å½•æ¨é€æˆåŠŸ
     */
    public void recordSuccess(String channel, String level) {
        pushSuccessCounter.labels(channel, level).inc();
    }
    
    /**
     * è®°å½•æ¨é€å¤±è´¥
     */
    public void recordFailure(String channel, String level, String reason) {
        pushFailureCounter.labels(channel, level, reason).inc();
    }
}
```

### 9.3 æ¨é€å¼‚å¸¸å¤„ç†

#### 9.3.1 æ¨é€å¤±è´¥é™çº§ç­–ç•¥

```
æ¨é€å¤±è´¥é™çº§æ–¹æ¡ˆï¼š
â”œâ”€â”€ æå…‰æ¨é€å¤±è´¥ â†’ é™çº§ä¸ºçŸ­ä¿¡
â”œâ”€â”€ çŸ­ä¿¡å¤±è´¥ â†’ é™çº§ä¸ºé‚®ä»¶
â”œâ”€â”€ WebSocketæ–­å¼€ â†’ é™çº§ä¸ºè½®è¯¢
â””â”€â”€ å…¨éƒ¨å¤±è´¥ â†’ è®°å½•å¤±è´¥æ—¥å¿—ï¼Œäººå·¥ä»‹å…¥
```

#### 9.3.2 æ¨é€é‡è¯•ç­–ç•¥

```java
@Service
public class AlertPushRetryStrategy {
    
    /**
     * æŒ‡æ•°é€€é¿é‡è¯•
     */
    public void retryWithBackoff(Alert alert, int retryCount) {
        // é‡è¯•é—´éš”ï¼š1åˆ†é’Ÿã€2åˆ†é’Ÿã€4åˆ†é’Ÿ
        long delay = (long) Math.pow(2, retryCount) * 60 * 1000;
        
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
        executor.schedule(() -> {
            try {
                pushService.push(alert);
            } catch (Exception e) {
                if (retryCount < 3) {
                    retryWithBackoff(alert, retryCount + 1);
                } else {
                    // é‡è¯•å¤±è´¥ï¼Œè®°å½•æ—¥å¿—
                    log.error("å‘Šè­¦æ¨é€å¤±è´¥ï¼Œå·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°: {}", alert.getAlertId());
                    notifyAdmin(alert);
                }
            }
        }, delay, TimeUnit.MILLISECONDS);
    }
}
```

### 9.4 æ¨é€æ€§èƒ½ä¼˜åŒ–

#### 9.4.1 æ‰¹é‡æ¨é€

```java
@Service
public class BatchPushService {
    
    /**
     * æ‰¹é‡æ¨é€ï¼ˆå‡å°‘ç½‘ç»œè¯·æ±‚ï¼‰
     */
    public void batchPush(List<Alert> alerts) {
        // æŒ‰çº§åˆ«åˆ†ç»„
        Map<String, List<Alert>> groupedAlerts = alerts.stream()
            .collect(Collectors.groupingBy(Alert::getLevel));
        
        // æ‰¹é‡æ¨é€
        groupedAlerts.forEach((level, alertList) -> {
            List<String> userIds = getUserIdsByLevel(level);
            
            // ä¸€æ¬¡æ€§æ¨é€ç»™æ‰€æœ‰ç”¨æˆ·
            jpushClient.sendToUsers(userIds, 
                buildBatchMessage(alertList));
        });
    }
}
```

#### 9.4.2 å¼‚æ­¥æ¨é€

```java
@Service
public class AsyncPushService {
    
    @Async("pushExecutor")
    public void asyncPush(Alert alert) {
        // å¼‚æ­¥æ¨é€ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
        pushService.push(alert);
    }
}

@Configuration
public class AsyncConfig {
    
    @Bean(name = "pushExecutor")
    public Executor pushExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(1000);
        executor.setThreadNamePrefix("push-");
        executor.initialize();
        return executor;
    }
}
```

---

## åã€æ€»ç»“å»ºè®®

### âœ… æ¨èé‡‡ç”¨ï¼šæ–¹æ¡ˆCï¼ˆåˆ†å±‚å­˜å‚¨ï¼‰

```
æ•°æ®åˆ†ç±»å­˜å‚¨ï¼š
â”œâ”€â”€ IoTDB: å…¨é‡æ—¶åºæ•°æ®ï¼ˆæ­£å¸¸+å¼‚å¸¸ï¼‰
â”œâ”€â”€ PostgreSQL: å‘Šè­¦æ•°æ® + çŠ¶æ€å˜æ›´ + èšåˆç»Ÿè®¡
â””â”€â”€ Redis: å®æ—¶ç¼“å­˜ + ä¼šè¯æ•°æ®

æ ¸å¿ƒç†å¿µï¼š
"æ—¶åºæ•°æ®äº¤ç»™æ—¶åºæ•°æ®åº“ï¼Œä¸šåŠ¡æ•°æ®äº¤ç»™å…³ç³»æ•°æ®åº“"
```

### ğŸ’¡ å…³é”®ä¼˜åŠ¿

1. **æ€§èƒ½æœ€ä¼˜**ï¼šIoTDBæ‰¿è½½é«˜é¢‘å†™å…¥ï¼ŒPostgreSQLå¤„ç†ä¸šåŠ¡æŸ¥è¯¢
2. **å­˜å‚¨åˆç†**ï¼šé¿å…æ•°æ®å†—ä½™ï¼Œé™ä½å­˜å‚¨æˆæœ¬
3. **æŸ¥è¯¢é«˜æ•ˆ**ï¼šå„å–æ‰€é•¿ï¼ŒæŸ¥è¯¢æ•ˆç‡æœ€é«˜
4. **æ‰©å±•æ€§å¼º**ï¼šæ˜“äºæ°´å¹³æ‰©å±•ï¼Œæ”¯æŒæµ·é‡æ•°æ®

### ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **ä¸è¦æŠŠæ—¶åºæ•°æ®å­˜PostgreSQL**ï¼šä¼šæ‹–å®æ•°æ®åº“
2. **å‘Šè­¦æ•°æ®å¿…é¡»å­˜PostgreSQL**ï¼šéœ€è¦å…³è”æŸ¥è¯¢ã€äº‹åŠ¡å¤„ç†
3. **Redisåªå­˜çƒ­æ•°æ®**ï¼šè®¾ç½®åˆç†çš„TTL
4. **å®šæ—¶ä»»åŠ¡åšèšåˆ**ï¼šé¿å…é¢‘ç¹æŸ¥è¯¢åŸå§‹æ•°æ®

---

**æ–¹æ¡ˆæ€»ç»“**: 
- **IoTDB** = å…¨é‡æ—¶åºå­˜å‚¨ + å†å²æŸ¥è¯¢
- **PostgreSQL** = ä¸šåŠ¡æ•°æ®å­˜å‚¨ + å…³è”æŸ¥è¯¢
- **Redis** = å®æ—¶ç¼“å­˜ + æ€§èƒ½åŠ é€Ÿ

è¿™ä¸ªæ¶æ„æ—¢èƒ½ä¿è¯æ€§èƒ½ï¼Œåˆèƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œæ˜¯å·¥ä¸šç‰©è”ç½‘çš„æœ€ä½³å®è·µï¼