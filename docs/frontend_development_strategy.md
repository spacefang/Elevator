# 前端开发与三级权限体系实施策略

作为资深前端设计师，基于 `docs` 目录下的设计文档（特别是《三级权限矩阵》与《功能模块》），我为您制定了以下开发策略。

## 一、 核心问题解答

### 1. 后端如何配合？（关键契约）

前端要实现“三级权限”，不能仅靠前端 `v-if` 隐藏按钮，**后端必须在数据层面做强管控**。你需要要求后端做到以下几点：

1.  **统一接口，数据隔离 (Data Scope)**

    - **不要**设计三套接口（如 `/api/national/list`, `/api/city/list`）。
    - **要**使用统一接口（如 `/api/devices`）。后端通过解析 Token 中的角色（User Role），自动在数据库层追加 `WHERE` 条件。
    - _前端收益_：一套代码调用同一个 API，不同账号登录看到不同数据，逻辑复用率极高。

2.  **权限标识透传**

    - 登录接口 `/api/auth/login` 或 `/api/auth/me` 返回的用户信息中，必须明确包含 `permissions: string[]` 数组。
    - 示例数据：`['device:view', 'device:edit', 'device:remote_control']`。
    - _前端收益_：前端可以直接用指令 `<button v-permission="['device:edit']">` 控制按钮显示。

3.  **Mock 数据分层支持**
    - 在后端未开发完成前，后端需提供 Swagger 或 Mock 接口，且要能模拟三种角色的返回数据。
    - 比如：请求 Mock 接口带 `Role: City` 头，返回只有本市的数据；带 `Role: National` 返回全国聚合数据。

### 2. 开发顺序：层级并行还是串行？

建议采用 **“框架先行，纵向切片，自底向上”** 的策略。

- **第一步：框架先行 (Common Core)**

  - 先搞定 **登录 -> 路由守卫 -> 动态菜单 -> 权限指令** 这套通用机制。
  - 无论哪个层级，这套骨架是共用的。

- **第二步：纵向切片 (Vertical Slice)**

  - **不要**按“先做完市级所有功能，再做省级”的方式。
  - **建议**按“功能模块”开发，比如先做 **[设备管理]**，一次性把 市级（看详情/控梯）、省级（编辑/调动）、国级（统计）做通。
  - _理由_：这样能尽早验证“一套接口适配三种角色”的架构是否合理。

- **第三步：自底向上 (Bottom-Up)**
  - 在具体模块内部，优先开发 **[市级-执行层]**。
  - _理由_：市级是数据的**产生源**（产生告警、产生工单、维保打卡）。没有底层数据，省/国级的“统计分析”就是空中楼阁，无法测试。

### 3. 如何处理“功能差异”？

针对三级权限的功能差异（如下表），前端架构应采用 **“基础组件 + 动态插槽/扩展”** 的模式。

| 场景     | 差异点                         | 解决方案                                                                                           |
| :------- | :----------------------------- | :------------------------------------------------------------------------------------------------- |
| **视图** | 市级看列表，国级看地图聚合     | **动态组件**：`<component :is="roleViewComponent" />` (如 `DeviceListCity` vs `DeviceMapNational`) |
| **操作** | 市级可“远程控制”，省级无此按钮 | **指令控制**：`<btn v-permission="['control']">`                                                   |
| **表单** | 录入工单字段不同               | **配置化表单**：根据角色加载不同的 Form Schema (JSON 配置表单项)                                   |

---

## 二、 实施落地计划

### 阶段 1：权限骨架搭建 (Foundation)

- [ ] **Store 设计**：建立 `userStore`，存储 `role` (角色), `scope` (数据范围), `permissions` (权限点列表)。
- [ ] **路由守卫**：实现 `router.beforeEach`，根据权限动态挂载路由表（比如市级用户不加载“跨省调拨”页面的路由）。
- [ ] **自定义指令**：实现 `v-permission`，用于细粒度控制按钮显隐。

### 阶段 2：标杆模块开发 (Pilot) —— 以“告警中心”为例

- 这是一个典型的三级差异模块：
  - **市级**：看到告警 -> 按钮是 [去处理]、[转工单]。
  - **省级**：看到告警 -> 按钮是 [督办]、[查看进度]。
- **开发动作**：
  1.  与后端确认 `/api/alarms` 接口，确保返回字段支持两种视图。
  2.  开发 `AlarmDetail.vue`，内部通过 `v-if="isCity"` 显示处理表单，`v-if="isProvince"` 显示督办记录。

### 阶段 3：可视化与统计 (Dashboard)

- 这是国/省级的重点。由于市级数据已经跑通（阶段 2），此时汇总数据水到渠成。
- 引入 ECharts，开发“驾驶舱”组件。

---

## 三、 给后端的具体协作 Ref (抄送后端)

请后端同事重点关注 `docs/design/三级权限矩阵-监管与执行分离.md` 中的 **RBAC 模型**。前端将严格依赖后端返回的 `permissions` 数组进行渲染。

**前端期望的 UserInfo 响应结构：**

```json
{
  "code": 200,
  "data": {
    "userId": "1001",
    "name": "武汉张三",
    "role": "CITY_OPERATOR",
    "region": "湖北", // 数据范围-省
    "city": "武汉", // 数据范围-市
    "permissions": [
      "device:monitor:realtime", // 前端据此显示“实时监控”TAB
      "device:control:emergency", // 前端据此显示“远程急停”按钮
      "workorder:execute:city"
    ]
  }
}
```
