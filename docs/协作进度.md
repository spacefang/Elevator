# 前后端协作进度与联调约定

> **用途**：作为每日/每次迭代的“单一事实源”（SSOT）。前端开始开发前先阅读；双方完成事项、需要对方配合事项、接口变更都在此汇总。
>
> **更新规则**
> - 谁改谁写：每次提交前更新“完成/待办/需对方配合/变更日志”
> - 接口先改契约：接口新增/变更先更新 `docs/openapi.yaml`，再实现/再联调
> - 兼容优先：字段“先加后删”，废弃字段至少保留一个迭代周期
> - 文档归口：`docs/**` 统一在 `master` 维护，定期合并到 `backend`/`frontend`

## 1. 当前里程碑（MVP）

- 目标：登录 → 告警列表 → 告警详情（可联调、可演示）
- 后续：MQTT 接入 → 告警/状态入库 → WebSocket 推送 → 实时状态页 → 曲线页（IoTDB）

## 2. 联调环境信息

- 后端 Base URL：`http://localhost:8080`
- Swagger UI：`http://localhost:8080/swagger-ui/index.html`
- OpenAPI 契约：`docs/openapi.yaml`
- Docker 依赖启动：见 `deploy/README.md`
  - PostgreSQL：`localhost:5432`
  - Redis：`localhost:6379`
  - EMQX：Dashboard `http://localhost:18083`，MQTT `localhost:1883`
- 前端开发地址（默认）：`http://localhost:5173`（已在后端 CORS 白名单内，可按需调整）

## 3. 接口联调约定（前端必读）

- 认证流程
  1) `POST /api/auth/login` → 拿到 `accessToken`
  2) 之后所有 `/api/**` 请求都带：`Authorization: Bearer <accessToken>`
  3) `GET /api/auth/me` 用于校验 token 是否有效、获取当前用户信息
- 分页约定
  - `GET /api/alarms?page=0&size=20`
  - 返回格式：`{ content, totalElements, totalPages, page, size }`
- 错误返回
  - 格式：`{ code, message }`（例如 `UNAUTHORIZED` / `NOT_FOUND`）

## 4. 前端任务清单（Vue）

> 说明：前端在动手前先对照接口契约与本节任务优先级；做完后把“完成情况/需要后端配合”补到第 6 节与第 7 节。

### P0（先做）

- [x] 登录页：账号/密码输入 + 调用 `POST /api/auth/login` + token 存储
- [x] Axios 封装：baseURL + `Authorization` 注入 + 401 统一处理（跳转登录）
- [x] 基础布局：菜单/路由守卫（未登录拦截）
- [x] 告警列表页：分页 + level 展示（颜色/标签）+ 点击进入详情
- [x] 告警详情页：基础字段展示 + 返回列表

### P1（随后做）

- [ ] 实时状态页（占位）：先做 UI 与路由，接口待后端给 `GET /api/devices/{id}/realtime`（后续补）
- [ ] 曲线页（占位）：时间窗选择 + 图表容器，接口待后端给 IoTDB 查询（后续补）

## 5. 后端任务清单（Spring Boot）

### P0（先做）

- [x] OpenAPI 契约：`docs/openapi.yaml`
- [x] 认证最小实现（dev token）：`/api/auth/login`、`/api/auth/me`
- [x] 告警查询：`GET /api/alarms`、`GET /api/alarms/{id}`
- [ ] 统一日志与请求追踪（requestId）

### P1（随后做）

- [ ] MQTT 接入（EMQX）：订阅消息、解析 payload（先适配文档样例）
- [ ] 分层写入：IoTDB（全量时序）+ PostgreSQL（告警/状态变更）+ Redis（最新状态）
- [ ] WebSocket 推送：告警/状态变更事件（事件名+payload 契约先写入 `docs/openapi.yaml` 或单独 schema）

## 6. 需要对方配合 / 阻塞项（每日更新）

### 前端需要后端配合

- [ ] （示例）告警 level 枚举与展示映射确认：`red/orange/yellow` 是否固定？
- [ ] （示例）告警详情是否需要“处理记录/工单关联”字段（若需要，补契约后再实现）
- [ ] **[新增]** 后端 `AlarmDto` 需补充字段：`status` (状态: PENDING/PROCESSING/CLOSED)、`location` (位置)、`activities` (处理历史)。目前前端详情页缺这些数据。

### 后端需要前端配合

- [x] （示例）登录页对接完成后，确认 token 存储策略（localStorage vs cookie）与退出登录行为

### 阻塞项

- [ ] （示例）MQTT 实际 topic 与 payload 与文档是否一致？若不一致需设备侧确认

## 7. 变更日志（按时间倒序追加）

> 格式：YYYY-MM-DD / 负责人 / 变更摘要 / 影响范围 / 是否需要对方改动

- 2026-01-07 / backend / 增加 `docs/openapi.yaml` 并实现 `auth + alarms` 最小联调闭环 / 前端需按 Bearer token 调用 / ✅需要前端对接
- 2026-01-08 / backend / 增加 MQTT 入库 + 内置模拟器 + 设备状态接口（devices/realtime/events）/ 前端可开始做“设备列表/实时状态/事件”页面 / ✅需要前端对接
- 2026-01-08 / frontend / 完成登录+告警列表+详情真实接口对接 / 发现 AlarmDto 缺失 status/location 等字段 / ✅需要后端对接

## 8. 需求与设计参考（开发前必读）

- 功能模块：`docs/design/功能模块.md`
- 三级权限矩阵：`docs/design/三级权限矩阵-监管与执行分离.md`
- 核心业务流程：`docs/design/核心业务流程详细设计.md`
- 数据分层存储架构：`docs/design/数据分层存储架构设计.md`
- 需求分析：`docs/需求分析.md`
- 后端技术架构：`docs/后端技术架构.md`
- 模拟数据与联调：`docs/模拟数据与联调.md`
